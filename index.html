<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; margin: 0; }

        /* Loading overlay */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .spinner {
            border: 6px solid #ddd;
            border-top: 6px solid #2a4d9f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .leaflet-popup-content h3 {
            margin: 0;
            font-size: 1.1em;
            color: #2a4d9f;
        }

        #filters {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 10000;
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }

        #filters input {
            margin: 2px 4px;
        }
    </style>
</head>
<body>
<div id="loading">
    <div class="spinner"></div> Loading tracks...
</div>

<div id="filters" style="top:auto; bottom:10px; left:50%; transform: translateX(-50%);">
    <label>Start Date: <input type="date" id="startDate"></label>
    <label>End Date: <input type="date" id="endDate"></label>
    <button onclick="filterTracks()">Filter</button>
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([46, 14.5], 6);

// Base layers
const baseLayers = {
    "OSM Standard": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }),
    "OSM Topo": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: '© OpenTopoMap contributors' }),
    "CyclOSM": L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', { attribution: '© CyclOSM, OpenStreetMap contributors' })
};

// Overlays
const overlays = {
    "Hiking Trails": L.tileLayer('https://tile.waymarkedtrails.org/hiking/{z}/{x}/{y}.png', { attribution: '© Waymarked Trails, OpenStreetMap contributors' })
};

baseLayers["OSM Standard"].addTo(map);
L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

// Globals
let geojsonData;
let trackLayers = [];

// Show loading spinner
document.getElementById("loading").style.display = "flex";

// Fetch merged GeoJSON
fetch('merged.geojson')
.then(res => res.json())
.then(data => {
    geojsonData = data;
    drawTracks(geojsonData.features);
    document.getElementById("loading").style.display = "none";
})
.catch(err => {
    console.error('Error loading merged.geojson:', err);
    document.getElementById("loading").innerHTML = "<div style='color:red;'>Failed to load data.</div>";
});

// Helper: extract date from track name
function getTrackDate(name) {
    const dateMatch = name.match(/^(\d{4}-\d{2}-\d{2})/);
    if (dateMatch) return new Date(dateMatch[1]);
    return null;
}

// Draw tracks on map
function drawTracks(features) {
    // Remove previous layers
    trackLayers.forEach(l => map.removeLayer(l));
    trackLayers = [];

    features.forEach(feature => {
        const geometry = feature.geometry;
        if (!geometry || geometry.type !== 'LineString') return;

        const coords = geometry.coordinates.map(c => [c[1], c[0]]);
        if (coords.length <= 1) return;

        const polyline = L.polyline(coords.slice(2), { color: 'blue', weight: 3, opacity: 1 }).addTo(map);

        // Popup
        polyline.on('click', function() {
            const props = feature.properties || {};
            const propsHtml = Object.entries(props)
                .filter(([key]) => key !== 'ele' && key !== 'type' && key !== 'sourceFile')
                .map(([key,value]) => {
                    if (key.toLowerCase() === 'descriptions') {
                        let html = value.replace(/\\"/g,'"').replace(/\\n/g,'')
                            .replace(/<h1[^>]*>.*?<\/h1>/gi,'')
                            .replace(/<h2[^>]*>.*?<\/h2>/gi,'')
                            .replace(/<hr[^>]*>/gi,'')
                            .replace(/^(?:\s*<br\s*\/?>){1,2}/i,'')
                            .replace(/<p>/gi,'<p style="margin:2px 0;">')
                            .replace(/<p>\s*<\/p>/gi,'');
                        return html.trim();
                    }
                    return '<strong>' + key + ':</strong> ' + value;
                }).join('<br>');

            const rawName = props.sourceFile || feature.properties.name || 'Unnamed Track';
            const name = rawName.split('__')[0].trim();

            const popupContent = `
                <h3 style="margin:0; font-size:1.1em;">${name}</h3>
                <button onclick="showDetails(this)" style="margin-top:5px; padding:4px 8px;">See details</button>
                <div class="details" style="display:none; margin-top:8px;">${propsHtml}</div>
            `;
            polyline.bindPopup(popupContent).openPopup();
        });

        trackLayers.push(polyline);
    });

    // Fit bounds
    const bounds = L.featureGroup(trackLayers).getBounds();
    if (bounds.isValid()) map.fitBounds(bounds);
}

// Toggle details in popup
function showDetails(button) {
    const detailsDiv = button.nextElementSibling;
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        button.textContent = 'Hide details';
    } else {
        detailsDiv.style.display = 'none';
        button.textContent = 'See details';
    }
}

// Filter by date range
function filterTracks() {
    if (!geojsonData) return;

    const start = new Date(document.getElementById('startDate').value);
    const end = new Date(document.getElementById('endDate').value);

    const filtered = geojsonData.features.filter(f => {
        const name = f.properties.sourceFile || f.properties.name || '';
        const d = getTrackDate(name);
        return d && (!isNaN(start) ? d >= start : true) && (!isNaN(end) ? d <= end : true);
    });

    drawTracks(filtered);
}
</script>
</body>
</html>
